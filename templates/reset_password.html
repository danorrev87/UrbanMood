<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>UrbanMood - Nueva contraseña</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0d0d0d;margin:0;padding:0; }
    .login-wrapper { width:100%;max-width:420px;padding:40px 44px;background:#111;border:1px solid #242424;border-radius:18px;box-shadow:0 6px 28px -6px rgba(0,0,0,.55),0 2px 6px -2px rgba(0,0,0,.35);font-family:'Poppins',sans-serif; }
    .login-wrapper h1 { font-size:1.6rem;margin:0 0 2rem;color:#c2d03a;text-align:center;font-weight:700; }
    .login-wrapper form { display:grid;gap:18px; }
    .login-wrapper label { font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:#d3d7db;font-weight:600;display:block;margin-bottom:6px; }
    .login-wrapper input { width:100%;padding:13px 15px;border:1px solid #303030;border-radius:10px;background:#181818;color:#f2f2f2;font-size:0.95rem;line-height:1.2;box-sizing:border-box; }
    .login-wrapper input:focus { outline:none;border-color:#b6c628;box-shadow:0 0 0 2px rgba(182,198,40,.25); }
    .login-wrapper button { width:100%;background:#b6c628;color:#101410;font-weight:600;border:none;padding:15px 18px;border-radius:12px;cursor:pointer;font-size:1.05rem;transition:.25s;letter-spacing:.5px; }
    .login-wrapper button:hover { background:#cadd32; }
    #form-msg { font-size:.78rem;margin:4px 0 0; }
    #form-msg.error { color:#ff6b6b; }
    #form-msg.success { color:#6fdc90; }
    .back-link { display:block;margin-top:26px;text-align:center;font-size:.8rem;color:#889197;text-decoration:none; }
    .back-link:hover { color:#c2d03a; }
    .error-page { text-align:center; }
    .error-page h1 { color:#ff6b6b; }
    .error-page p { color:#9aa0a5; font-size:.9rem; margin:0 0 24px; }
    @media (max-width:520px){
      .login-wrapper { padding:34px 26px; }
    }
  </style>
</head>
<body>
  <div class="login-wrapper">
    {% if error %}
    <div class="error-page">
      <h1>Enlace inválido</h1>
      <p>{{ error }}</p>
      <a class="back-link" href="/forgot-password">Solicitar nuevo enlace</a>
    </div>
    {% else %}
    <h1>Nueva contraseña</h1>
    <form id="reset-form" novalidate>
      <div>
        <label for="password">Nueva contraseña</label>
        <input id="password" name="password" type="password" required minlength="8" placeholder="Mínimo 8 caracteres">
      </div>
      <div>
        <label for="confirm">Confirmar contraseña</label>
        <input id="confirm" name="confirm" type="password" required minlength="8" placeholder="Repetir contraseña">
      </div>
      <button type="submit">Guardar contraseña</button>
      <p id="form-msg" style="display:none"></p>
    </form>
    <a class="back-link" href="/login">&larr; Volver al login</a>
    {% endif %}
  </div>
{% if not error %}
<script>
  const form = document.getElementById('reset-form');
  const msg = document.getElementById('form-msg');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.style.display = 'none';
    const password = form.password.value;
    const confirm = form.confirm.value;
    if(password !== confirm) {
      msg.className = 'error';
      msg.textContent = 'Las contraseñas no coinciden';
      msg.style.display = 'block';
      return;
    }
    if(password.length < 8) {
      msg.className = 'error';
      msg.textContent = 'La contraseña debe tener al menos 8 caracteres';
      msg.style.display = 'block';
      return;
    }
    try {
      const res = await fetch(window.location.pathname, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password})
      });
      const j = await res.json();
      if(j.success) {
        msg.className = 'success';
        msg.textContent = j.message;
        msg.style.display = 'block';
        form.querySelector('button').disabled = true;
        setTimeout(() => window.location.href = '/login', 2000);
      } else {
        msg.className = 'error';
        msg.textContent = j.message;
        msg.style.display = 'block';
      }
    } catch(err){
      msg.className = 'error';
      msg.textContent = 'Error de red';
      msg.style.display = 'block';
    }
  });
</script>
{% endif %}
</body>
</html>
