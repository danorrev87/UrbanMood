<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Image Organizer V2 - UrbanMood</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { text-align: center; color: #333; }
        .instructions {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .stat { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #e74c3c; }
        .muscle-group {
            background: white;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .muscle-header {
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .muscle-header .count {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
        }
        .drop-zone {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            font-size: 16px;
            border: 3px dashed #ddd;
            margin: 20px;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover { border-color: #bbb; background: #fafafa; }
        .drop-zone.drag-over {
            border-color: #e74c3c;
            background: #fff5f5;
            color: #e74c3c;
            transform: scale(1.02);
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
            display: none;
        }
        .images-grid.show { display: grid; }
        .image-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.2s;
        }
        .image-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .image-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .image-card .filename {
            font-size: 11px;
            color: #666;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 5px;
        }
        .image-card .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .image-card:hover .remove-btn { opacity: 0.9; }
        .image-card .remove-btn:hover { opacity: 1; background: #c0392b; }
        .actions {
            position: sticky;
            top: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
            z-index: 100;
        }
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: 600;
        }
        button:hover { background: #c0392b; }
        button.secondary { background: #95a5a6; }
        button.secondary:hover { background: #7f8c8d; }
        .output {
            background: #2c3e50;
            color: #2ecc71;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            display: none;
            margin-top: 20px;
            font-size: 13px;
        }
        .output.show { display: block; }
    </style>
</head>
<body>
    <h1>üèãÔ∏è Exercise Image Organizer</h1>
    
    <div class="instructions">
        <h2>How to Use:</h2>
        <ol>
            <li><strong>Drag & Drop Images</strong> onto each muscle group section below</li>
            <li>You can add multiple images to each section</li>
            <li>Images will be automatically numbered within their group</li>
            <li>Click "Generate Commands" when finished to get rename scripts</li>
        </ol>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="total-count">0</div>
            <div>Total Images Added</div>
        </div>
    </div>

    <div class="actions">
        <button onclick="generateCommands()">üìã Generate Rename Commands</button>
        <button class="secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>

    <div id="muscleGroups"></div>

    <div class="output" id="output"></div>

    <script>
        const muscleGroups = [
            { name: 'PECHO', emoji: 'üí™' },
            { name: 'ESPALDA', emoji: 'üîô' },
            { name: 'HOMBROS', emoji: 'üôå' },
            { name: 'B√çCEPS', emoji: 'üí™' },
            { name: 'TR√çCEPS', emoji: 'üí™' },
            { name: 'PIERNAS', emoji: 'ü¶µ' },
            { name: 'ABDOMEN', emoji: 'üéØ' },
            { name: 'GL√öTEOS', emoji: 'üçë' },
            { name: 'CARDIO', emoji: '‚ù§Ô∏è' },
            { name: 'FUNCIONAL', emoji: '‚ö°' }
        ];
        
        // Store images by group  key
        const imagesByGroup = {};
        let exerciseCounter = 1;

        function init() {
            console.log('Initializing muscle groups...', muscleGroups.length);
            const container = document.getElementById('muscleGroups');
            console.log('Container found:', container);
            
            muscleGroups.forEach(group => {
                imagesByGroup[group.name] = [];
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'muscle-group';
                groupDiv.innerHTML = `
                    <div class="muscle-header">
                        <span>${group.emoji} ${group.name}</span>
                        <span class="count" id="count-${group.name}">0 images</span>
                    </div>
                    <div class="drop-zone" data-group="${group.name}">
                        <div>üìÅ Drop images here or click to select</div>
                        <div style="font-size:14px;margin-top:10px;color:#bbb;">Add as many exercises as needed</div>
                        <input type="file" accept="image/*" multiple style="display:none" id="file-input-${group.name}">
                    </div>
                    <div class="images-grid" id="grid-${group.name}"></div>
                `;
                
                container.appendChild(groupDiv);
                setupDropZone(group.name);
            });
            
            updateStats();
        }

        function setupDropZone(groupName) {
            const dropZone = document.querySelector(`[data-group="${groupName}"]`);
            const fileInput = document.getElementById(`file-input-${groupName}`);
            
            // Click to select files
            dropZone.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(groupName, Array.from(e.target.files));
            });
            
            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length > 0) {
                    handleFiles(groupName, files);
                } else {
                    alert('Please drop image files only');
                }
            });
        }

        function handleFiles(groupName, files) {
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagesByGroup[groupName].push({
                        filename: file.name,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    });
                    renderGroup(groupName);
                    updateStats();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderGroup(groupName) {
            const grid = document.getElementById(`grid-${groupName}`);
            const images = imagesByGroup[groupName];
            
            if (images.length === 0) {
                grid.classList.remove('show');
                return;
            }
            
            grid.classList.add('show');
            grid.innerHTML = images.map((img, index) => `
                <div class="image-card">
                    <button class="remove-btn" onclick="removeImage('${groupName}', ${index})">√ó</button>
                    <img src="${img.dataUrl}" alt="${img.filename}">
                    <div class="filename">${img.filename}</div>
                </div>
            `).join('');
            
            // Update count
            const countText = images.length === 1 ? '1 image' : `${images.length} images`;
            document.getElementById(`count-${groupName}`).textContent = countText;
        }

        function removeImage(groupName, index) {
            imagesByGroup[groupName].splice(index, 1);
            renderGroup(groupName);
            updateStats();
        }

        function updateStats() {
            const total = Object.values(imagesByGroup).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('total-count').textContent = total;
        }

        function generateCommands() {
            let exerciseId = 1;
            const commands = [];
            const dbUpdates = [];
            
            muscleGroups.forEach(group => {
                const images = imagesByGroup[group.name];
                images.forEach((img, index) => {
                    const ext = img.filename.substring(img.filename.lastIndexOf('.')).toLowerCase();
                    const newName = `ejercicio-${exerciseId}${ext}`;
                    
                    if (img.filename !== newName) {
                        commands.push(`mv "${img.filename}" "${newName}"`);
                    }
                    
                    dbUpdates.push(`db.query(Ejercicio).filter(Ejercicio.id==${exerciseId}).update({'image_url': '/static/images/ejercicios/${newName}'})`);
                    exerciseId++;
                });
            });

            if (commands.length === 0) {
                alert('No images added yet! Drag and drop some images first.');
                return;
            }

            const output = document.getElementById('output');
            output.innerHTML = `# Navigate to the images folder
cd /Users/daniloorrego/Documents/Danilo/UrbanMood/static/images/ejercicios

# Rename commands (${commands.length} files)
${commands.join('\n')}

# After renaming, update the database:
cd /Users/daniloorrego/Documents/Danilo/UrbanMood
source .venv/bin/activate

python -c "
from db import SessionLocal
from models import Ejercicio

db = SessionLocal()

# Update image URLs
${dbUpdates.join('\n')}

db.commit()
print('‚úÖ Updated ${commands.length} exercise image URLs')
db.close()
"
`;
            output.classList.add('show');
            output.scrollIntoView({ behavior: 'smooth' });
        }

        function clearAll() {
            if (confirm('Clear all images? This cannot be undone.')) {
                muscleGroups.forEach(g => {
                    imagesByGroup[g.name] = [];
                    renderGroup(g.name);
                });
                updateStats();
                document.getElementById('output').classList.remove('show');
            }
        }

        async function loadExistingExercises() {
            try {
                const response = await fetch('/admin/ejercicios/organized');
                const data = await response.json();
                
                if (data.success && data.exercises) {
                    // Map body sections to our group names
                    const sectionMap = {
                        'pecho': 'PECHO',
                        'espalda': 'ESPALDA',
                        'hombros': 'HOMBROS',
                        'biceps': 'B√çCEPS',
                        'triceps': 'TR√çCEPS',
                        'piernas': 'PIERNAS',
                        'abdomen': 'ABDOMEN',
                        'gluteos': 'GL√öTEOS',
                        'cardio': 'CARDIO',
                        'funcional': 'FUNCIONAL'
                    };
                    
                    // Load existing images
                    for (const [section, exercises] of Object.entries(data.exercises)) {
                        const groupName = sectionMap[section];
                        if (groupName && imagesByGroup[groupName]) {
                            exercises.forEach(ex => {
                                if (ex.image_url) {
                                    // Extract just the filename from the full path
                                    const filename = ex.image_url.split('/').pop();
                                    imagesByGroup[groupName].push({
                                        filename: filename,
                                        dataUrl: ex.image_url, // Use the actual URL
                                        id: ex.id,
                                        isExisting: true
                                    });
                                }
                            });
                            renderGroup(groupName);
                        }
                    }
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading existing exercises:', error);
            }
        }

        // Initialize
        init();
        loadExistingExercises();
    </script>
</body>
</html>
